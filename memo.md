# 入門監視 モダンなモニタリングのためのデザインパターン

## 第1章 監視のアンチパターン

### アンチパターン1：ツール依存

- 監視ツールに銀の弾丸はない
- 優れたツールを入れるのは良いが、優れた監視を仕組みを作ることが最優先である
- 監視は1つのツールで解決できるものではない
- ツールとは仕事のやり方、前提、文化的あるいは社会的な規範が具現化したもの

### アンチパターン2：役割としての監視

- 監視をするには理解もできないものを監視する仕組みは作ることは難しい
  - 監視とは役割ではなくスキルである
  - チームメンバー全員がある程度監視ができるスキルレベルを保持するべきである
- サービスを管理するのであれば監視は最優先項目の1つにするべきである
- チームメンバーの1人に監視の全責任を押し付けるようなことは無いにするべきである

### アンチパターン3：チェックボックス監視

チェックボックスの監視: これを監視していますというための監視システムのこと

- 監視を設定する人がシステムの動作を完全に理解していない状態だと、シンプルで簡単なものの監視設定をしただけで終わってしまう
- 「動いている」とはどう言う意味か。「動いている」かどうかを監視するべき
- アラートは何が悪いかを教えてくれるとは限らない
  - アラートは「何かがおかしい」ことを示す優れた指標
- CPU利用率が高いから異常ではない
  - やるべき処理をしているのであればCPU使用率が高負荷であっても良い
- メトリクスは高頻度で取得するべき
  - 高頻度でのメトリクス取得はナンセンスという人もいるが、モダンなサーバやネットワーク危機は後世のであるため負荷等は簡単に処理できる
  - 最低でも60秒に1回はメトリクスを取得するようにする

### アンチパターン4：監視を支えにする

- 監視とは問題を通知することに長けているもの
- 通知を受け取った後にする問題の修正を忘れてはいけない
- 監視を増やしても壊れたシステムが直るわけでは無い

### アンチパターン5：手動設定

- 監視設定は100%児童化すべきである
- 新しい関し設定やノードの追加をすぐにできないと、より良い監視システムを作ることがストレスになってします

### まとめ

- ツールに依存しても、監視の仕組みは良くならない
- 監視はチームメンバー全員がやるべきであり、チームや部署内での役割では無い
- 良い監視とはチェックボックスに「これは監視してます」とチェック入れるだけで済むものではない
- 監視するだけで壊れたシステムは直せない
- 自動化が足りていないということは、何か重要なことを見落としている可能性を知る良い方法

## 第2章 監視のデザインパターン

### デザインパターン1: 組合せ可能な監視

専門化されたツールを複数使い、それらを疎結合させ監視プラットフォームを作ること

- 組み合わせ可能な監視は1つのツールに縛られないというメリットがある
  - やり方が合わないツールがあれば、そのツールのみを置き換えれば良い
  - プラットフォーム全体を置き換える必要はない

監視いステムを構築するには以下5つの要素がある

#### データ収集

- データ収集を行う方法として**プッシュ**と**プル**がある
  - [監視ツールの「Push型」と「Pull型」について](https://www.evolva-its.com/2019/11/08/%E7%9B%A3%E8%A6%96%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AE-push%E5%9E%8B-%E3%81%A8-pull%E5%9E%8B-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6/)
  - [モニタリングシステムの Push 型 Pull 型アプローチと Prometheus についての考察](https://yasuharu519.hatenablog.com/entry/2017/12/16/215855)
- どのようなデータを集めるにしてもメトリクスとログの２種類のデータがあることに注意する
- メトリクスには「カウンタ」と「ゲージ」の２種類の表現方法がある

#### データストレージ

- データ収集後の保存場所
- CLINICSだと通常RDSに保存されるが、一定期間をすぎるとS3とかにアーカイブされる？
  - 調べた方が良い

#### 可視化
- 目に見える形にしてくれるやつ
  - DataDog, NewRelic..
- 可視化はツールを用いて自身やチームの求めるものに沿った形でデータを理解することが大切
  - 自分用にカスタマイズすることが大切
- 優れた監視の背景にある原則は、自身やチームの環境で最適に動く仕組みを作ること

#### 分析とレポート
- ユースケースとしてアプリケーションとサービスのサービスレベルアグリーメント(SLA)を決定しレポート化することがある
- SLA: サービス提供者と顧客との間で取り交わされるアプリケーションやサービスに期待される可用性についての契約
  - SLAはサービス提供者が目指すべき目標の一つ

## デザインパターン2: ユーザ視点での監視

#### アラート

- 監視とはアラートを出すために存在しているのではない
  - 問題が発生した際にアラートを出すことが監視システムの目的ではない
- アラートは監視の結果の1つであり、それらの問題を修復することが本質
- 監視はできるだけユーザの近いところから始めるべきである
  - ユーザのどのような影響を与えているかを考えることから始める
- 「このメトリクスはユーザへの影響をどう教えてくるるのだろうか」常に考える

## デザインパターン3: 作るのではなく買う

- ツール導入する際はメンテナンスコストを考える
- 監視ツールを設計する専門家ではないため、おそらく自作するよりも何も考えず買った方がコストを安く抑えることができる
  - 余った時間をプロダクトにフォーカスすることができる

## デザインパターン4: 継続的改善

- 監視の仕組みは時間と共に変わっていく
  - トレンドの移り変わり、扱うデータ
- 世界レベルの監視の仕組みは数ヶ月あるいは数年間にわたる継続した注意深さと改善から生まれる

## まとめ
- 組み合わせ可能な監視の仕組みは、もの理シックな仕組みよりも効果的
- ユーザ視点優先での監視によって、より効果的な可視化ができる
- 監視の仕組みは、可能な限り自分で作るのではなく買う
- 常に改善し続けることが大切

## 第3章 アラート、オンコール、インシデント管理

アラートの文脈には2つの意味がある

#### 誰かを叩き起こすためのアラート

- 緊急対応が求められるケース
  - 電話、SMS、アラームなどの方法でアラートを送る
  - PagerDutyのようなやつ

#### 参考情報(FYI)としてのアラート

- 緊急対応の必要はないが、アラートが来たことを誰かが確認する必要があるケース
  - バックアップの失敗、ジョブの失敗等
- これらのアラートはSlack等のチャットに通知することが好ましい

参考情報(FYI)としてのアラートは事実上のアラートではなく、単なるメッセージであり、誰かを叩き起こすためのアラートが事実上のアラート。

- 良いアラートの仕組みを作るには6つの方法がある
  - アラートにメールを使うのはやめる
  - 手順書を書く
    - アラートが飛んできた際にどう対応するべきかの手順書をまとめる
      - これは何のサービスで何をするものか
      - 誰が責任者か
      - どんな依存性を持っているか
      - インフラ構成はどのようなものか
      - どんなメトリクスやログを送っていて、それらはどういう意味か
      - どんなアラートが設定されており、それらはどういう理由で設定されているのか
  - 固定の閾値を決めることだけが、アラートを発動する方法ではない
    - 「空き容量10%以下」という固定された閾値を決めてしまうと11%~80%まで急激に増加するケースを見逃してしまうため、固定の閾値を決めることだけに集中するべきではない
    - 変化量やグラフの傾きなどをうまく用いルことが大切
  - アラートを削除しチューニングする
    - 同じようなアラートが多くなると「このアラート前にも見たな。数分したら勝手に消えるから何もしないでよい」となってしまう
    - 時間が経つにつれて、アラート疲れを引き起こしてしまう
    - アラートに鈍感になってしまうほど膨大なアラートを受け取るとアラート疲れが発生する
    - アラート疲れの対策はアラートを減らせば良い
      - 全てのアラートが誰かがアクションする必要があるか
      - 1ヶ月菅野アラート履歴を確認し、どんなアクションを取り影響はどうだったかを考え削除するかを決断する
      - アラートを完全削除するためにどんな自動化の仕組みが作れるか検討する
  - メンテナンス期間を使う
    - 作業中はメンテナンスモードにすること
    - 謝ったアラートが飛ぶとチームメンバーに迷惑を書ける可能性がある
  - まずは自動復旧を試す
    - ドキュメントの手順に沿って対応しているだけであれば自動化するべきである
    - 自動復旧を試しても尚、問題が解決できないのであればアラートを送るべきである

### 無用な場当たり的対応を減らす

- 監視自体は何も修復してくれない
- 何かが壊れたなら担当者が対応する必要がある
- 場当たり的な対応をやめのためにはシステムを改善するために時間を使わなければならない
- 場当たり的な対応を減らすためには以下2つの施策が効果的である
  - オンコールシフト中、場当たり的な対応をしていない時間は、システム回復力や安定性に対して取り組むのをオンコール担当の役割にする
  - 前週にオンコールの際に収集した情報を元に、次の週のスプリント計画やチーム会議の際にシステムの回復性や安定性について取り上げる計画を立てる
- 週替わりでオンコールシフトを組む
  - オンコール対応をすることでより良いものを開発しようという意欲が生まれる

### インシデント管理

インシデントの認識と対応に関する正式で一貫した方法があることで、チームには一定の厳格さと規律が生まれる。
以下のインシデント対応の方法をチーム内で参考にすると良いかもしれない。

1. インシデントの認識(監視が問題を認識)
2. インシデントの記録(インシデントに対して監視の仕組みが自動でチケットを作成)
3. インシデントの診断、分類、解決、クローズ(オンコール担当がトラブルシュート、問題を修正し、チケットにコメントや情報を添えて解決済みとする)
4. 必要に応じて問題発生中にコミュニケーションを取る
5. インシデント解決後、回復力を高めるための改善策を考える

サービス停止を伴うインシデントについては明確に定義された以下の役割が重要になる。それぞれの役割は1つの機能が割り当てられ、2つ以上の兼務は避けるべきである。

1. 現場指揮官

インシデント中のモノゴトを決断する役割

- サービス停止に関する調査を監視することが役割である
- インシデント初期段階ではオンコール担当がこの役割を担うことがあるが、適任者がいれば引き継ぐことが大切

2. スクライブ

インシデント中に発生した事実を記録する役割

- 「だれが何をいつ行ったか」、「どんな決断がされたのか」、「どんなフォローアップすべき事項が見つかったのか」を記録する

3. コミュニケーション調整役

社内外問わず利害関係者に最新状況のコミュニケーションを取る役割

- インシデント対応する人や何が起きているのかを知りたい人たちにとって、この人が唯一のコミュニケーションポイント
- インシデント対応者に直接コミュニケーションを取ると邪魔にしかならないため、このような役割を設ける必要がある
  - 邪魔することがないようにする(効率的にインシデントを解決させる)ためにも必要

4. SME(subject matter expert)

- インシデント対応者

## まとめ

- アラートは難しいが、いくつかヒントを活用することで正しい方向へ進める
- アラートをメールで送らない
- 手順書を書く
- 全てのアラートがシンプルな閾値で決められるわけではない
- 常にアラートを見直そう
- メンテナンス期間を使おう
- 誰かにアラートを送る前に自動復旧を試す
- いくつかの方法を使えばオンコールの仕組みを改善するのは難しくない
- 自社にあったシンプルで使い道のあるインシデント管理プロセスを作るのを優先する

## 第4章 統計入門

## 第5章 ビジネスを監視する

## 第6章 フロントエンド監視

## 第7章 アプリケーション監視

## 第8章 サーバ監視

## 第9章 ネットワーク監視

## 第10章 セキュリティ監視

## 第11章 監視アセスメントの実行


# その他

- https://dev.classmethod.jp/articles/practial-monitoring-bookreview/
